#!/usr/bin/env bash

# Video Conversion for Cross Device with FFmpeg
# https://gist.github.com/jaydenseric/220c785d6289bcfd7366
#
#Social Media Video encodings
# - https://trac.ffmpeg.org/wiki/Encode/YouTube

# Best Youtube settings
# - https://support.google.com/youtube/answer/1722171?hl=en
# - https://superuser.com/questions/866798/what-ffmpeg-command-line-matches-the-one-youtube-uses

# RATE CONTROL - https://slhck.info/video/2017/03/01/rate-control.html
# To summarize, here’s what you should do, depending on your use case:

# - Archival — CRF that gives you the quality you want.
# - Streaming — Two-pass CRF or ABR with VBV-constained bitrate.
# - Live Streaming — One-pass CRF or ABR with VBV-constained bitrate, or CBR if you can waste bits.
# - Encoding for Devices — Two-pass ABR, typically.

# Video encoding guide
# https://trac.ffmpeg.org/wiki/Encode/H.264

# Send output stream to dev/null
# https://stackoverflow.com/questions/20323640/ffmpeg-deocde-without-producing-output-file#answer-20325676

declare -r CORES="4"
declare -rx INPUT="-i $1"
declare -rx OUTPUT=${2:-dev/null}
declare -r  FFMPEG=$(which ffmpeg)
declare -r  STATS="-stats"
declare -r  THREADS="-threads $CORES"
declare -r  FORMAT=$((test ! "$2" && echo "-f null") || echo "-f mp4" )
declare -r  SAMPLES="-ar 48000"
# declare -r STAMP="-copyts"
# declare -r BASE="-copytb -1"
declare -r  BITRATE="-b:a 128K"
declare -r  VOLUME="-vol 256"         # Audio volume level (0-256)
declare -r  PIXELS="-pix_fmt yuv420p" # Chroma subsampling: 4:2:0 Quicktime Pixel format https://trac.ffmpeg.org/wiki/Encode/H.264#Encodingfordumbplayers
declare -r  CODECS="-c:a aac"
declare -r  SYNC="-vsync cfr"         # (-async for audio) Video sync https://www.cleancss.com/explain-command/ffmpeg/6658
declare -r  RATE="-r 24000/1001"      # FPS (Frame Rate Per Second) (Assume YouTube's default frame rate is 24.)
                                      # PLACE BEFORE OUTPUT TO FORCE
                                      # http://www.reduser.net/forum/showthread.php?102725-24P-or-23-976P-That-is-the-question

declare -r QUICKTIME="-movflags +faststart $PIXELS" # https://trac.ffmpeg.org/wiki/Encode/AAC#ProgressiveDownload
declare -r MAPS="-map 0"
declare -r SCALE="scale=1920x1080,setdar=16:9" # Scale (use n:-2 to keep aspect ratio) https://trac.ffmpeg.org/wiki/Scaling
declare -r FILTERS="-vf $SCALE -filter_threads $CORES -filter_complex_threads $CORES"

time $FFMPEG \
  $INPUT     \
  $BASE      \
  $SYNC      \
  $STAMP     \
  $STATS     \
  $THREADS   \
  $FILTERS   \
  $SAMPLES   \
  $CODECS    \
  $VOLUME    \
  $MAPS      \
  $QUICKTIME \
  $RATE      \
$OUTPUT


# LUTS
#  - https://ffmpeg.org/pipermail/ffmpeg-user/2014-May/021356.html
#   -vf lut3d=<lut file> -c:a copy output

# SEEKING https://trac.ffmpeg.org/wiki/Seeking
# *** SEEK BEFORE INPUT for cover image ***
#   -ss [start]     \ seek start time offset
#   -t [duration]   \ seek duration time (precedence over -to)
#   -to [end]       \ seek end time
#
# read PNG images with filename img001, img002, img003, etc..
# img can be changed to another prefix
# %03d can be changed to %04d for 0001, %05d for 00001 formats, etc...
# -i img%03d.png    \
#   -report         \
#   -vn             \ # Disable video
#   -an             \ # Disable audio
#   -pre preset     \
#
# FILTERS https://ffmpeg.org/ffmpeg-filters.html#Filtergraph-description
#   -filter_threads 4         \
#   -filter_complex_threads 4 \
#   -vf                       \  # Video filter
#     scale=1920x1080         \ # Scale (use n:-2 to keep aspect ratio) https://trac.ffmpeg.org/wiki/Scaling
#    ,setdar=16:9             \ # Another way to set video resolution
#   -af audio filter          \ # Audio filter
#   -filter [filter]          \ # Main filter
#
# FORMAT
#   -g 12           \ # or -g 15 varies on YouTube's FPS.(The default, 12, works for 24-25 fps. For NTSC and 30 fps, select 15.* FFMPEG option: -g, Not sure what youtube's default FPS is if it is 24 or 30. I assume 24 since the default 12 would be half the frame rate and 15 if their fra
#   -f format       \ # force format (image2, )
#   -bf 2           \ # Youtube Consecutive B Frame (default 16)
#   -vbr 2          \ # Variable bit rate
#   -crf 23         \ # crf (constant rate factor) quality (51 worst, 0 lossless, 18-28 is sane, default 23)
#   -b:v 1M         \ # video bitrate (-b)
#   -minrate 1M     \
#   -maxrate 1M     \
#   -bufsize 2M     \
#   -tune stillimage \  # ** USED FOR IMAGES **
#   -shortest       \ # Possibly used for shortest audio track
#   -framerate 24   \ # ** USED FOR IMAGES **
#   -frames:v 1     \ # (-vframes) ** USED FOR IMAGES **
#   -profile:v high \ # High profile for YouTube)
#   -level 4.0      \ # Profile level
#   -aspect 16:9    \ # Aspect Ratio (4:3, 16:9, 1.3333)
#
# CODECS
#   -c:v libx264    \ # codec (shorthand) (e.g. copy, etc.)
#   -acodec aac     \ # codec (longform)  (e.g. copy, etc.) Fraunhofer is best `-c:a libfdk_aac`
#   -vcodec libx264 \ # codec (longform)  (e.g. copy, etc.)
#   -coder 1        \ # (YouTube: By default CABAC is the entropy encoder used by x264.)
#
# output.avi

### 2-PASS https://slhck.info/video/2017/03/01/rate-control.html#2-pass-average-bitrate-2-pass-abr
# ffmpeg -i <input> -c:v libx264 -b:v 1M -pass 1 -f mp4 /dev/null
# ffmpeg -i <input> -c:v libx264 -b:v 1M -pass 2 <output>.mp4

###################################################################################

for i in *.$1
  do
    echo $i
  done
