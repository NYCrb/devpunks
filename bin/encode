#!/usr/bin/env bash

# Video Conversion for Cross Device with FFmpeg
# https://gist.github.com/jaydenseric/220c785d6289bcfd7366
#
#Social Media Video encodings
# - https://trac.ffmpeg.org/wiki/Encode/YouTube

# FFMPEG and How to Use It Wrong - https://videoblerg.wordpress.com/2017/11/10/ffmpeg-and-how-to-use-it-wrong/

# Best Youtube settings
# - https://support.google.com/youtube/answer/1722171?hl=en
# - https://superuser.com/questions/866798/what-ffmpeg-command-line-matches-the-one-youtube-uses

# RATE CONTROL - https://slhck.info/video/2017/03/01/rate-control.html
# To summarize, here’s what you should do, depending on your use case:

# - Archival — CRF that gives you the quality you want.
# - Streaming — Two-pass CRF or ABR with VBV-constained bitrate.
# - Live Streaming — One-pass CRF or ABR with VBV-constained bitrate, or CBR if you can waste bits.
# - Encoding for Devices — Two-pass ABR, typically.

# Video encoding guide
# https://trac.ffmpeg.org/wiki/Encode/H.264

# Send output stream to dev/null
# https://stackoverflow.com/questions/20323640/ffmpeg-deocde-without-producing-output-file#answer-20325676

declare -rx INPUT="-i $1"
declare -rx OUTPUT=${2:-dev/null}

# SEEKING https://trac.ffmpeg.org/wiki/Seeking
# *** SEEK BEFORE INPUT for cover image ***
declare -r START="-ss 00:00:00" # seek start time offset
declare -r DURATION="-t 60"   # seek duration time (precedence over -to)
declare -r END= #"-to [end]"       # seek end time
declare -r SEEK="$START $DURATION $END"

declare -r  CORES=4
declare -r  MAPS="-map 0"
declare -r  STATS="-stats"
declare -r  REPORT="-report"
declare -r  FFMPEG=$(which ffmpeg)
declare -r  THREADS="-threads $CORES -filter_threads $CORES -filter_complex_threads $CORES"
declare -r  FORMAT=$( ( test ! "$2" && echo -f null ) || echo -f mp4 ) # image2 for still frames
declare -r  STAMP="-copyts"
# declare -r BASE="-copytb -1"
declare -r  TUNE="-tune film"                           # Possible tunes: film animation grain stillimage psnr ssim fastdecode zerolatency
declare -r  CODECS="$TUNE -ac 2 -c:a aac -c:v libx264 -x264opts no-scenecut" # Fraunhofer is best but need to compile `-c:a libfdk_aac`
declare -r  SYNC="-vsync vfr"                           # 0 (passthrough), 1 (cfr), 2 (vfr), drop, auto
                                                        # (-async for audio) Video sync https://www.cleancss.com/explain-command/ffmpeg/6658

# Keyframe interval (or GOP length). -g 15 varies on YouTube's FPS.(The default, 12, works for 24-25 fps. For NTSC and 30 fps, select 15.* FFMPEG option: -g, Not sure what youtube's default FPS is if it is 24 or 30. I assume 24 since the default 12 (or 15) would be half the frame rate
declare -r  KEYFRAMES="-g 24 -keyint_min 12"            # https://sites.google.com/site/linuxencoding/x264-ffmpeg-mapping
# SAMPLE RATE &  FPS (Frame Rate Per Second) (Assume YouTube's default frame rate is 24FPS 48000Hz)
# 24000/1001 (23.976fps). 30000/1001 (29.970fps). 60000/1001 (59.94fps)
# PLACE BEFORE OUTPUT TO FORCE
# http://www.reduser.net/forum/showthread.php?102725-24P-or-23-976P-That-is-the-question
declare -r  FREQUENCY="$KEYFRAMES -r 24000/1001 -ar 48000"
declare -r  PRESET="-preset veryfast"                  # fast, veryfast, slow, veryslow
declare -r  PROFILE="-profile:v baseline -level:v 3.0" # baseline, main, high
declare -r  BITRATE="-b:a 128K -b:v 1M -bufsize 2M -minrate 1M -maxrate 1M -crf 23"
                                                       # crf (constant rate factor) quality (51 worst, 0 lossless, 18-28 is sane, default 23)
declare -r  PIXELS="-pix_fmt yuv420p"                  # Chroma subsampling: 4:2:0 Quicktime Pixel format https://trac.ffmpeg.org/wiki/Encode/H.264#Encodingfordumbplayers
declare -r  QUICKTIME="-movflags +faststart $PIXELS"   # https://trac.ffmpeg.org/wiki/Encode/AAC#ProgressiveDownload

# SCALE https://trac.ffmpeg.org/wiki/Scaling
#  - https://ffmpeg.org/ffmpeg-scaler.html
#  - http://nickyguides.digital-digest.com/bilinear-vs-bicubic.htm
declare -r  WIDTH=1080
declare -r  HEIGHT=1080
printf  -v  ASPECT "%.3f" "$((WIDTH/HEIGHT))"
declare -r  COEFFICIENT="min($WIDTH/(iw*sar)\,$HEIGHT/(ih*sar))" # Use SAR for anamorphic video
declare -r  RESOLUTION="max($WIDTH\,trunc($COEFFICIENT*(iw*sar)/2)*2):max($HEIGHT\,trunc($COEFFICIENT*(ih*sar)/2)*2)"
# LETTERBOXING
# https://stackoverflow.com/questions/8133242/ffmpeg-resize-down-larger-video-to-fit-desired-size-and-add-padding
# https://superuser.com/questions/547296/resizing-videos-with-ffmpeg-avconv-to-fit-into-static-sized-player/1136305#1136305
declare -r  LETTERBOX="pad=$WIDTH:$HEIGHT:($WIDTH-($COEFFICIENT*(iw*sar)))/2:($HEIGHT-($COEFFICIENT*(ih*sar)))/2:color=green"
# declare -r ASPECT="-aspect 16:9" # Aspect Ratio (4:3, 16:9, 1.3333) (DEPRECATED?)
declare -r  ALGORITHM="flags=+bicubic" # https://i.stack.imgur.com/AaIAW.png
declare -r  SCALE="scale=$RESOLUTION:force_original_aspect_ratio=decrease:flags=bicubic,setsar=sar=w/h,setdar=dar=$ASPECT"
declare -r  DEINTERLACE="yadif=send_frame:auto:all"
# FILTERS https://ffmpeg.org/ffmpeg-filters.html#Filtergraph-description
#         http://manpages.ubuntu.com/manpages/cosmic/man1/ffmpeg-filters.1.html
declare -r  SPEED="setpts=1.0*PTS" # Multiplier. (Higher = longer, Lower = shorter)

declare -r  VIDEO_FILTERS="-filter:v $SCALE,$SPEED,$DEINTERLACE" # https://ffmpeg.org/ffmpeg-filters.html#yadif-1
declare -r  VOLUME="volume=0.20"                       # Audio volume level 0-256 (256 = normaled)
declare -r  AUDIO_FILTERS="-filter:a $VOLUME"          # Audio Filters
declare -r  FILTER= # -filter [filter]                 # Main filter
declare -r  FILTERS="$AUDIO_FILTERS $VIDEO_FILTERS"


echo ASPECT $ASPECT
echo SCALE $SCALE

time $FFMPEG \
  $SEEK      \
  $INPUT     \
  $PROFILE   \
  $PRESET    \
  $BASE      \
  $SYNC      \
  $STAMP     \
  $STATS     \
  $REPORT    \
  $THREADS   \
  $FILTERS   \
  $CODECS    \
  $MAPS      \
  $QUICKTIME \
  $FREQUENCY \
  $BITRATE   \
  $FORMAT    \
$OUTPUT


# LUTS
#  - https://ffmpeg.org/pipermail/ffmpeg-user/2014-May/021356.html
#   -vf lut3d=<lut file> -c:a copy output

# read PNG images with filename img001, img002, img003, etc..
# img can be changed to another prefix
# %03d can be changed to %04d for 0001, %05d for 00001 formats, etc...
# -i img%03d.png    \
#   -vn             \ # Disable video
#   -an             \ # Disable audio
#
# FORMAT
#   -bf 2           \ # Youtube Consecutive B Frame (default 16)
#   -vbr 2          \ # Variable bit rate
#   -shortest       \ # Possibly used for shortest audio track
#   -framerate 24   \ # ** USED FOR IMAGES **
#   -frames:v 1     \ # (-vframes) ** USED FOR IMAGES **
#
# CODECS
#   -coder 1        \ # (YouTube: By default CABAC is the entropy encoder used by x264.)

### 2-PASS https://slhck.info/video/2017/03/01/rate-control.html#2-pass-average-bitrate-2-pass-abr
# ffmpeg -i <input> -c:v libx264 -b:v 1M -pass 1 -f mp4 /dev/null
# ffmpeg -i <input> -c:v libx264 -b:v 1M -pass 2 <output>.mp4

###################################################################################

for i in *.$1
  do
    echo $i
  done
