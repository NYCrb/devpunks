#!/usr/bin/env bash

echo Loading filters

# Experiments with FFmpeg frei0r Filters
#   - https://yalantis.com/blog/experiments-with-ffmpeg-filters-and-frei0r-plugin-effects/

: ${BIN? ❌ not set} ${SCALE? ❌ not set} ${DEINTERLACE? ❌ not set}

source $BIN/.luts
source $BIN/.letterbox

watermark () {
  echo WATERMARK FILE: $WATERMARK
  echo "-i $WATERMARK"
}

$(watermark)

# http://ffmpeg.org/ffmpeg-all.html#setpts_002c-asetpts
declare -r  SPEED="setpts=1.0*PTS" # Multiplier. (Higher = longer, Lower = shorter)
# declare -r  VIDEO_FILTERS="-filter:v $SCALE,$DEINTERLACE,$LUT,$SPEED" # https://ffmpeg.org/ffmpeg-filters.html#yadif-1
#declare -r  VIDEO_FILTERS="-i $WATERMARK -filter:v $SCALE,$DEINTERLACE,$LETTERBOX -filter_complex overlay=10:10" # :$SPEED" # https://ffmpeg.org/ffmpeg-filters.html#yadif-1
declare -r  VIDEO_FILTERS="-filter_complex $SCALE,$DEINTERLACE,$LETTERBOX[scaled];[scaled][1:v]overlay=10:10[out] -map [out] -map 0:a" # :$SPEED" # https://ffmpeg.org/ffmpeg-filters.html#yadif-1

# VOLUME https://stackoverflow.com/questions/38085408/complex-audio-volume-changes-with-ffmpeg
#declare -r  VOLUME="volume=-3dB"                      # Audio volume level 0-256 (256 = normaled) (-100dB = "silence" logrithmic curving)
declare -r  FADE_IN="volume=enable='between(t,0,20)':volume='t/20.0':eval=frame"
declare -r  FADE_OUT="volume=enable='between(t,40,60)':volume='1-(t-40)/20.0':eval=frame"
declare -r  VOLUME="$FADE_IN,$FADE_OUT"                # Audio volume level 0-256 (256 = normaled) (-100dB = "silence" logrithmic curving)
# declare -r  AUDIO_FILTERS="-filter:a $VOLUME"        # Audio Filters
declare -r  FILTER= # -filter [filter]                 # Main filter
declare -r  FILTERS="$AUDIO_FILTERS $VIDEO_FILTERS"
